# GitHub Actions workflow - è‡ªåŠ¨å‘å¸ƒ Release ç‰ˆæœ¬
name: Release APK

# è§¦å‘æ¡ä»¶ï¼šåˆ›å»ºç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ (å¦‚ v1.0.0)
on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Build and Release APK
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸åˆ›å»º Release
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. è·å–ç‰ˆæœ¬å·
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      # 3. è®¾ç½® Java ç¯å¢ƒ (JDK 17)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      # 4. è®¾ç½® Flutter ç¯å¢ƒ
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      # 5. è·å–ä¾èµ–
      - name: Get dependencies
        working-directory: ./video_editor
        run: flutter pub get

      # 6. æ„å»º Release APK
      - name: Build APK
        working-directory: ./video_editor
        run: flutter build apk --release

      # 7. æ„å»ºåˆ†åŒ… APK
      - name: Build Split APKs
        working-directory: ./video_editor
        run: flutter build apk --release --split-per-abi

      # 8. é‡å‘½å APK æ–‡ä»¶
      - name: Rename APKs
        run: |
          cd video_editor/build/app/outputs/flutter-apk/
          mv app-release.apk video_editor_v${{ steps.version.outputs.VERSION }}.apk
          mv app-arm64-v8a-release.apk video_editor_v${{ steps.version.outputs.VERSION }}_arm64-v8a.apk
          mv app-armeabi-v7a-release.apk video_editor_v${{ steps.version.outputs.VERSION }}_armeabi-v7a.apk
          mv app-x86_64-release.apk video_editor_v${{ steps.version.outputs.VERSION }}_x86_64.apk

      # 9. åˆ›å»º GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Video Editor v${{ steps.version.outputs.VERSION }}
          body: |
            ## ğŸ“± Video Editor v${{ steps.version.outputs.VERSION }}
            
            ### ä¸‹è½½è¯´æ˜
            - **video_editor_v${{ steps.version.outputs.VERSION }}.apk** - é€šç”¨ç‰ˆæœ¬ï¼ˆè¾ƒå¤§ï¼Œå…¼å®¹æ‰€æœ‰è®¾å¤‡ï¼‰
            - **video_editor_v${{ steps.version.outputs.VERSION }}_arm64-v8a.apk** - é€‚ç”¨äºç°ä»£ 64 ä½æ‰‹æœºï¼ˆæ¨èï¼‰
            - **video_editor_v${{ steps.version.outputs.VERSION }}_armeabi-v7a.apk** - é€‚ç”¨äºè€æ—§ 32 ä½æ‰‹æœº
            - **video_editor_v${{ steps.version.outputs.VERSION }}_x86_64.apk** - é€‚ç”¨äºæ¨¡æ‹Ÿå™¨æˆ– x86 è®¾å¤‡
            
            ### æ›´æ–°å†…å®¹
            - è¯·æŸ¥çœ‹ commit å†å²äº†è§£è¯¦ç»†æ›´æ–°
            
          files: |
            video_editor/build/app/outputs/flutter-apk/video_editor_*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
